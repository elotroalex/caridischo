
{% assign min_column_width = 1 %}

{% if include.facet_by and include.collection %}
    {% assign subset = site[include.collection] | where: include.field, include.value | sort: 'order' %}
    {% assign facet_list = include.facet_by | split: "|" %}

<!-- TEST -->
<h3>TEST</h3>
{% for item in facet_list %}
    {% if item == "language" %}
    {% assign original_options = subset | map: item | compact | uniq | sort_natural %}
    {% assign temp_languages_list = "" %}
    {% for option in original_options %}
        {% unless option contains "," %}
        {% capture temp_languages_list %}{{ temp_languages_list | append: option}}|{% endcapture %}
        {% endunless %}
    {% endfor %}
    {% for option in original_options %}
        {% if option contains "," %}
        {% assign lang_list = {{option}} | split: "," %}
        {% for l in lang_list %}
            {% capture temp_languages_list %}{{ temp_languages_list | append: l}}|{% endcapture %}
        {% endfor %}
        {% else  %}
        {% endif %}
    {% endfor %}

    {% capture temp_languages_list%}{{ temp_languages_list | remove: " "}}{% endcapture %}
    {% assign languages = temp_languages_list | split: "|" | uniq %}

<p>My temp array: </p>

<h4>Deduped List</h4>
<ul>
    {% for language in languages %}
    <li>{{language}}</li>
    {% endfor %}
</ul> 

<h4>Original List</h4>
<ul>
    {% for option in original_options %}
    <li>{{option}}</li>
    {% endfor %}
</ul> 
    {% else %}
    {% endif %}

{% endfor %}

<!-- END-TEST -->

<form class="row" id="facets">
    {% for item in facet_list %}
        {% comment%}Handle Language Category{% endcomment %}
        {% if item == "language" %}
        {% comment%}Create Array of Unique Languages{% endcomment %}
        {% assign original_options = subset | map: item | compact | uniq | sort_natural %}
        {% assign temp_languages_list = "" %}
        {% for option in original_options %}
            {% unless option contains "," %}
            {% capture temp_languages_list %}{{ temp_languages_list | append: option}}|{% endcapture %}
            {% endunless %}
        {% endfor %}
        {% for option in original_options %}
            {% if option contains "," %}
            {% assign lang_list = {{option}} | split: "," %}
            {% for l in lang_list %}
                {% capture temp_languages_list %}{{ temp_languages_list | append: l}}|{% endcapture %}
            {% endfor %}
            {% else  %}
            {% endif %}
        {% endfor %}
    
        {% capture temp_languages_list%}{{ temp_languages_list | remove: " "}}{% endcapture %}
        {% assign languages = temp_languages_list | split: "|" | uniq %}

        {% comment%}Populate FieldSet with unique languages{% endcomment %}
        
        <fieldset id="language-set" class="card ml-2 facet-card">
            <div class="facet-header">
                <a class="facet-bn" data-toggle="collapse" href="#language-collapse" role="button" aria-expanded="false" aria-controls="language-collapse">
                    <legend>
                        language                        
                        <span aria-hidden="true" class="facets-chevron facets-chevron-bottom float-right ml-2"></span>
                    </legend>
                </a>               
            </div>
            <div class="collapse" id="language-collapse">
                <div class="card-body">
                    {% for language in languages %}
                        <div class="facet-item">
                            <input id="{{language | slugify}}" class="{{item | slugify}}" type="checkbox" name="{{language}}" value="{{language}}"/>
                            <label for="{{language}}">{{language}}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </fieldset>

        {% else %}
        <fieldset id="{{item | slugify}}-set" class="card ml-2 facet-card">
            <div class="facet-header">
                <a class="facet-bn" data-toggle="collapse" href="#{{item | slugify }}-collapse" role="button" aria-expanded="false" aria-controls="{{item | slugify }}-collapse">
                    <legend>
                        {{item | replace: "_", " "}}
                        <span aria-hidden="true" class="facets-chevron facets-chevron-bottom float-right ml-2"></span>
                    </legend>
                </a>
                {% assign options = subset | map: item | compact | uniq | sort_natural
            %}
            </div>
            <div class="collapse" id="{{item | slugify }}-collapse">
                <div class="card-body">
                    {% for option in options %}
                        <div class="facet-item">
                            <input id="{{option | slugify}}" class="{{item | slugify}}" type="checkbox" name="{{option}}" value="{{option}}"/>
                            <label for="{{option}}">{{option}}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </fieldset>
        {% endif %}
    {% endfor %}
</form>

<!-- Build the gallery by iterating through items in the collection. If there are
          facets specified, fine the items' values for those fields and add them as
          classes to the gallery-item object. The classes are used by JavaScript
          that reacts to changes to the checkbox filters. -->

<div class="wax-gallery-container full-width" id="wax-gallery-{{ include.value | downcase | replace: ' ', '-' }}-container">
    <div class="wax-inline-container">
        <div class="wax-gallery" id="wax-gallery-{{ include.value | downcase | replace: ' ', '-' }}">
            <div class="row">
                {% for item in subset %}
                    {% assign newClasses = '' | split: ' ' %}
                    {% for fieldSet in facet_list %}
                        {% assign itemFieldValue = item[fieldSet] %}
                        {% if itemFieldValue.first %}
                            {% assign fieldSetArray = '' | split: ' ' %}
                            {% for val in itemFieldValue %}
                                {% assign slugVal = val | slugify | split: ' ' %}
                                {% assign fieldSetArray = fieldSetArray | concat: slugVal %}
                            {% endfor %}
                        {% else %}
                            {% assign fieldSetArray = itemFieldValue | slugify | split: ' ' %}
                        {% endif %}
                        {% assign newClasses = newClasses | concat: fieldSetArray %}
                    {% endfor %}
                    <div class="gallery-item-facets {{  newClasses | join: ' ' }}">
                        <a href='{{ item.url | absolute_url }}'>
                            <div class='hovereffect'>
                                <img class='img-responsive gallery-wide-thumb' src='{{site.baseurl}}/img/derivatives/simple/{{ item.pid }}/fullwidth.jpg'/>
                                <div class='overlay'>
                                    <p class='info'>{{ item.label }}</p>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        console.log({{ facet_list | jsonify }})
        // liquid array of one or more fields for facetting
        // This JavaScript controls the expanding and contracting facet headers.
        // Additional JS for this page in assets/js/facets.js
        $(".facet-bn[aria-expanded]").click(function (event) {
            $(this)
                .parent()
                .parent()
                .toggleClass("active");
            // this selector might return multiple elements
            $(this)
                .children("legend")
                .children(".facets-chevron")
                .toggleClass("facets-chevron-bottom facets-chevron-top");
        });
    });
</script>

{% else %}
<p style="color: red">
    Check your code. You didn't specify what to face by.
    <code>include</code>
    command.
</p>

{% endif %} 